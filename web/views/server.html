<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/">
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
        }

        .top-bar {
            background-color: #7289DA;
            padding: 10px;
            text-align: right;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1;
        }

        .top-bar a {
            color: white;
            text-decoration: none;
            margin-right: 15px;
        }

        .dashboard-container {
            display: flex;
            align-items: flex-start; /* Zmiana na flex-start */
            margin-top: 20px;
            height: 95.9vh;
            background-color: #2C2F33;
            color: white;
            padding: 20px;
        }

        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: auto;
            margin-left: 20px; /* Now on the left */
        }

        #avatar {
            border-radius: 50%;
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
        }

        #name {
            font-size: 24px;
        }

        .logout-link {
            margin-top: 20px;
            color: #7289DA;
            text-decoration: none;
        }

        /* Style for server details */
        .server-details {
            margin-right: 20px;
            color: white;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <a href="https://discord.com/api/oauth2/authorize?client_id=928399458570502155&permissions=8&scope=bot+applications.commands"
            target="_blank">Invite</a>
        <a href="/" class="text-sm mt-5 logout-link">Logout</a>
    </div>

    <div class="dashboard-container">
        <div class="avatar-container">
            <img src='' id="avatar" class="rounded-full w-12 h-12" />
            <div id="name"></div>
        </div>

        <!-- Container for server details -->
        <div class="server-details">
            <!-- Content will be added here dynamically -->
        </div>
    </div>
    <script>
window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('access_token');
    const tokenType = urlParams.get('token_type');
    const serverId = urlParams.get('server_id');

    if (!accessToken || !tokenType || !serverId) {
        window.location.href('/');
        console.log("Błąd logowania");
    }

    // Fetch user information
    fetch('https://discord.com/api/users/@me', {
        headers: {
            authorization: `${tokenType} ${accessToken}`,
        },
    })
    .then(result => result.json())
    .then(response => {
        console.log(response);
        const { username, discriminator, avatar, id } = response;
        // Set the welcome username string
        document.getElementById('name').innerText = ` ${username}#${discriminator}`;

        // Set the avatar image by constructing a URL to access Discord's CDN
        document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${id}/${avatar}.jpg`;

        // Fetch user's guilds (servers)
        fetch('https://discord.com/api/users/@me/guilds', {
            headers: {
                authorization: `${tokenType} ${accessToken}`,
            },
        })
        .then(guildsResult => guildsResult.json())
        .then(guildsResponse => {
            console.log(guildsResponse);

            // Find the specific server in the user's guilds
            const server = guildsResponse.find(guild => guild.id === serverId);

            if (server) {
                // Set the server name in the server details container
                document.querySelector('.server-details').innerText = server.name;
            } else {
                console.error("Serwer nie został znaleziony w liście serwerów użytkownika.");
            }
        })
        .catch(console.error);
    })
    .catch(console.error);
};
    </script>
</body>

</html>
