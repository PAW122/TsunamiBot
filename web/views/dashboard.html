<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/">
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
        }

        .top-bar {
            background-color: #7289DA;
            padding: 10px;
            text-align: right;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1;
        }

        .top-bar a {
            color: white;
            text-decoration: none;
            margin-right: 15px;
        }

        .server_list {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 95.9vh;
            background-color: #2C2F33;
            color: white;
            padding: 20px;
        }

        .avatar-container {
            position: absolute;
            top: 40px;
            right: 0;
            margin-top: 20px;
            margin-right: 20px;
            display: flex;
            align-items: center;
        }

        #avatar {
            border-radius: 50%;
            width: 60px;
            height: 60px;
            margin-right: 15px;
        }

        #name {
            font-size: 24px;
            margin-right: 15px;
        }

        .logout-link {
            margin-top: 20px;
            color: #7289DA;
            text-decoration: none;
        }

        /* Style for server details */
        .server-details {
            margin-top: 20px;
            color: white;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <a href="https://discord.com/api/oauth2/authorize?client_id=928399458570502155&permissions=8&scope=bot+applications.commands"
            target="_blank">Invite</a>
        <a href="/" class="text-sm mt-5 logout-link">Logout</a>
        <a id="consoleLink" href="#" class="console_page">Console</a>
    </div>

    <div class="dashboard-container">

        <div class="server_list">

        </div>

        <div class="avatar-container">
            <img src='' id="avatar" class="rounded-full w-12 h-12" />
            <div id="name"></div>
        </div>

        <!-- Container for server details -->
        <div class="server-details">
            <!-- Content will be added here dynamically -->
        </div>
    </div>

    <script>
        window.onload = () => {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const [accessToken, tokenType] = [fragment.get('access_token'), fragment.get('token_type')];
    
            if (!accessToken) {
                window.location.href('/');
            }
    
            const consoleLink = document.getElementById('consoleLink');
            consoleLink.href = `/console/${accessToken}/${tokenType}`;

            // Fetch user information
            fetch('https://discord.com/api/users/@me', {
                headers: {
                    authorization: `${tokenType} ${accessToken}`,
                },
            })
            .then(result => result.json())
            .then(response => {
                const { username, discriminator, avatar, id } = response;
                //set the welcome username string
                document.getElementById('name').innerText = ` ${username}#${discriminator}`;
    
                //set the avatar image by constructing a URL to access Discord's CDN
                document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${id}/${avatar}.jpg`;
    
                // Fetch user's guilds (servers)
                fetch('https://discord.com/api/users/@me/guilds', {
                    headers: {
                        authorization: `${tokenType} ${accessToken}`,
                    },
                })
                .then(guildsResult => {
                    if (!guildsResult.ok) {
                        throw new Error(`HTTP error! Status: ${guildsResult.status}`);
                    }
                    return guildsResult.json();
                })
                .then(guildsResponse => {
    
                    const serverListContainer = document.querySelector('.server_list');
    
                    guildsResponse.forEach(guild => {
                        const serverElement = document.createElement('div');
                        
                        // Check if the user is an administrator of the server
                        if (guild.owner) {
                            // If the user is an admin, modify the server name link
                            const serverLink = document.createElement('a');
                            serverLink.href = `/server?access_token=${accessToken}&token_type=${tokenType}&server_id=${guild.id}`;
                            serverLink.textContent = guild.name;
                            serverElement.appendChild(serverLink);
                        } else {
                            // If the user is not an admin, use a plain div
                            serverElement.textContent = guild.name;
                        }
    
                        serverListContainer.appendChild(serverElement);
                    });
                })
                .catch(console.error);
            })
            .catch(console.error);
        };
    </script>
</body>

</html>
